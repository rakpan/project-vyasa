#!/usr/bin/env bash
#
# Project Vyasa - Environment Bootstrap
# Purpose: Generate secrets without mutating deploy/.env or .env.example.
# Output: deploy/.secrets.env (git-ignored)
#
# [Decision] Credentials are auto-generated by default to prevent hardcoded leaks;
# override manually in .env if needed.
#
# Usage:
#   ./scripts/init_vyasa.sh --bootstrap-secrets
#   ./scripts/init_vyasa.sh --help

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DEPLOY_DIR="$PROJECT_ROOT/deploy"
SECRETS_FILE="$DEPLOY_DIR/.secrets.env"

usage() {
  cat <<EOF
Usage: $0 [--bootstrap-secrets] [--force]
  --bootstrap-secrets   Generate secrets into deploy/.secrets.env (idempotent)
  --force               Overwrite deploy/.secrets.env even if it exists
  --help                Show this help

Notes:
  - deploy/.env and deploy/.env.example are never modified by this script.
  - ARANGO_ROOT_PASSWORD is canonical for ArangoDB auth; ARANGODB_PASSWORD
    is read only for legacy compatibility.
EOF
}

BOOTSTRAP=false
FORCE=false

while [ $# -gt 0 ]; do
  case "$1" in
    --bootstrap-secrets) BOOTSTRAP=true ;;
    --force) FORCE=true ;;
    --help|-h) usage; exit 0 ;;
    *) echo "Unknown argument: $1" >&2; usage; exit 1 ;;
  esac
  shift
done

ensure_writable_dir() {
  local dir="$1"
  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
  fi
}

append_kv() {
  local key="$1"; local value="$2"; local target="$3"
  if ! grep -Eq "^${key}=" "$target" 2>/dev/null; then
    echo "${key}=${value}" >> "$target"
  fi
}

generate_secret() {
  openssl rand -hex 24
}

bootstrap_secrets() {
  ensure_writable_dir "$DEPLOY_DIR"

  # Prevent accidental rotation if volumes already exist (Arango lockout protection)
  local arango_data="/raid/vyasa/arangodb"
  local arango_has_data="false"
  if [ -d "$arango_data" ] && [ "$(find "$arango_data" -mindepth 1 -maxdepth 1 | wc -l)" -gt 0 ]; then
    arango_has_data="true"
  fi

  if [ -f "$SECRETS_FILE" ] && ! $FORCE; then
    echo "deploy/.secrets.env already exists. Use --force to regenerate."
    return
  fi

  # Start fresh if forcing; otherwise create if missing
  : > "$SECRETS_FILE"

  # Canonical secrets
  local arango_pw=""
  if [ -n "${ARANGO_ROOT_PASSWORD:-}" ]; then
    arango_pw="$ARANGO_ROOT_PASSWORD"
  elif [ -n "${ARANGODB_PASSWORD:-}" ]; then
    arango_pw="$ARANGODB_PASSWORD"
  fi

  if [ -z "$arango_pw" ]; then
    if [ "$arango_has_data" = "true" ]; then
      echo "ArangoDB data exists at $arango_data; not generating ARANGO_ROOT_PASSWORD to avoid lockout."
      echo "Add ARANGO_ROOT_PASSWORD to deploy/.secrets.env manually to match the existing volume."
    else
      arango_pw="$(generate_secret)"
    fi
  fi

  if [ -n "$arango_pw" ]; then
    append_kv "ARANGO_ROOT_PASSWORD" "$arango_pw" "$SECRETS_FILE"
  fi

  # Console / NextAuth secrets
  append_kv "CONSOLE_PASSWORD" "${CONSOLE_PASSWORD:-$(generate_secret)}" "$SECRETS_FILE"
  append_kv "CONSOLE_SECRET" "${CONSOLE_SECRET:-$(generate_secret)}" "$SECRETS_FILE"
  append_kv "NEXTAUTH_SECRET" "${NEXTAUTH_SECRET:-$(generate_secret)}" "$SECRETS_FILE"

  # Qdrant API key (optional; generate if empty)
  append_kv "QDRANT_API_KEY" "${QDRANT_API_KEY:-$(generate_secret)}" "$SECRETS_FILE"

  echo "Secrets written to $SECRETS_FILE"
}

if $BOOTSTRAP; then
  bootstrap_secrets
else
  usage
fi
