services:
  opik-postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      # Opik PostgreSQL configuration
      # OPIK_POSTGRES_USER: Optional, defaults to 'opik' if not set
      # OPIK_POSTGRES_PASSWORD: Required - set in deploy/.env
      # OPIK_POSTGRES_DB: Optional, defaults to 'opik' if not set
      POSTGRES_USER: ${OPIK_POSTGRES_USER:-opik}
      POSTGRES_PASSWORD: ${OPIK_POSTGRES_PASSWORD}
      POSTGRES_DB: ${OPIK_POSTGRES_DB:-opik}
    volumes:
      - /raid/vyasa/opik_data/postgres:/var/lib/postgresql/data
    networks:
      - vyasa-net
    ports:
      - "127.0.0.1:55432:5432"

  opik-redis:
    image: redis:7
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - /raid/vyasa/opik_data/redis:/data
    networks:
      - vyasa-net
    ports:
      - "127.0.0.1:56379:6379"

  opik-api:
    image: ghcr.io/comet-ml/opik/opik-backend:latest
    restart: unless-stopped
    depends_on:
      - opik-postgres
      - opik-redis
    environment:
      # Opik API configuration
      # DATABASE_URL: Constructed from OPIK_POSTGRES_* variables
      # OPIK_SECRET_KEY: Required - set in deploy/.env (use a strong random value)
      DATABASE_URL: postgres://${OPIK_POSTGRES_USER:-opik}:${OPIK_POSTGRES_PASSWORD}@opik-postgres:5432/${OPIK_POSTGRES_DB:-opik}
      REDIS_URL: redis://opik-redis:6379/0
      OPIK_SECRET_KEY: ${OPIK_SECRET_KEY}
    volumes:
      - /raid/vyasa/opik_data/opik:/var/lib/opik
    networks:
      - vyasa-net
    ports:
      - "127.0.0.1:56500:5000"

networks:
  vyasa-net:
    external: true
